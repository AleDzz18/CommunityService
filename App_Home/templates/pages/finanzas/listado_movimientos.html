{% extends "layouts/complete.html" %}
{% block toolbaritems %}
    <script type="module" src="https://unpkg.com/cally"></script>
    <div v-scope="{ tower: '{{ torre_seleccionada_id|default:'0' }}', date: '', startDate: '{{ filtro_form.fecha_inicio.value|default:'' }}', endDate: '{{ filtro_form.fecha_fin.value|default:'' }}', justStart: false, justEnd: false, ranges : [ { label: 'Ultimos 7 dias', days: 7 }, { label: 'Ultimos 14 dias', days: 14 }, { label: 'Ultimos 30 dias', days: 30 }, { label: 'Ultimos 3 meses', months: 3 }, { label: 'Ultimos 6 meses', months: 6 }, { label: 'Ultimo año', years: 1 } ], setDate(range){ if (range) { const endDate = new Date(); const startDate = new Date(endDate); if (range.days) { startDate.setDate(startDate.getDate() - range.days) } else if (range.months) { startDate.setMonth(startDate.getMonth() - range.months) } else if (range.years) {startDate.setFullYear(startDate.getFullYear() - range.years)} this.startDate = startDate.toISOString().slice(0, 10); this.endDate = endDate.toISOString().slice(0, 10); } else if (this.justEnd){ this.startDate = ''; this.endDate = this.date.split('/')[1]; } else if (this.justStart){ this.startDate = this.date.split('/')[0]; this.endDate = ''; } else { this.startDate = this.date.split('/')[0]; this.endDate = this.date.split('/')[1]; } this.get(); }, formatDate(){ if (!this.startDate && !this.endDate) return 'Fecha'; return `${this.startDate || 'X'} hasta ${this.endDate || 'X'}`; },setSelection(choice) { this.justStart = choice == 'start'; this.justEnd = choice == 'end'; }, get() { const data = { 'torre': this.tower, 'fecha_inicio': this.startDate, 'fecha_fin': this.endDate }; const query = new URLSearchParams(data).toString(); window.location.href = '{% url 'ver_finanzas_gestion' categoria_slug=categoria_slug %}' + '?' + query;}, downloadpdf(){ const baseUrl = '{% url 'descargar_pdf' categoria_slug=categoria_slug %}'; const currentParams = window.location.search; window.location.href = baseUrl + currentParams; } }"
         class="flex items-center justify-between w-full flex-wrap gap-1">
        <div>
            <select v-model="tower"
                    class="select select-ghost h-fit w-fit"
                    @change="get()">
                {# 1. Solo mostramos 'Todas las Torres' si NO es un Líder de Torre (LDT) #}
                {% if request.user.rol == 'LDG' or request.user.is_staff %}<option value="0">Todas las Torres</option>{% endif %}
                {# 2. El bucle de torres ya viene filtrado desde la vista (view.py) #}
                {% for torre in torres %}<option value="{{ torre.id }}">Torre {{ torre.nombre }}</option>{% endfor %}
            </select>
            <div class="dropdown w-full lg:w-fit lg:dropdown-start"
                 :class="{'dropdown-start': !date, 'dropdown-center': date}">
                <div tabindex="0"
                     role="button"
                     class="btn btn-ghost mx-1 h-fit w-full lg:w-fit flex justify-start ">
                    <span class="inline-block ">${formatDate()}</span>
                    <svg xmlns="http://www.w3.org/2000/svg"
                         class="size-2.5 inline-block"
                         viewBox="0 0 256 256">
                        <!-- Icon from Phosphor by Phosphor Icons - https://github.com/phosphor-icons/core/blob/main/LICENSE -->
                        <path fill="currentColor" d="m213.66 101.66l-80 80a8 8 0 0 1-11.32 0l-80-80A8 8 0 0 1 48 88h160a8 8 0 0 1 5.66 13.66" />
                    </svg>
                </div>
                <div tabindex="-1"
                     class="dropdown-content card bg-base-100 z-1 w-fit shadow-md max-sm:**:text-xs max-sm:**:h-fit  max-h-[calc(100svh-10rem)] overflow-y-scroll ">
                    <div class="card-body flex flex-col lg:flex-row justify-center items-center">
                        <div class="min-w-32 flex flex-row flex-wrap lg:flex-col justify-center max-sm:items-stretch w-full max-sm:**:py-1">
                            <button v-for="(range, index) in ranges"
                                    :key="index"
                                    class="btn btn-ghost rounded-none px-4 w-fit lg:w-full"
                                    @click="setDate(range)">${range.label}</button>
                        </div>
                        <div class="divider divider-horizontal"></div>
                        <div class="flex flex-col justify-stretch">
                            <div class="filter mb-2 self-center">
                                <input class="btn filter-reset btn-dash btn-primary [&&]:max-sm:h-fit [&&]:max-sm:w-1 [&&]:max-sm:aspect-auto "
                                       type="radio"
                                       name="datemode"
                                       aria-label="X"
                                       @click="setSelection('')" />
                                <input type="radio"
                                       name="datemode"
                                       aria-label="Solo inicio"
                                       class="btn btn-dash btn-primary "
                                       v-model="justStart"
                                       @click="setSelection('start')" />
                                <input type="radio"
                                       name="datemode"
                                       aria-label="Solo final"
                                       class="btn btn-dash btn-primary "
                                       v-model="justEnd"
                                       @click="setSelection('end')" />
                            </div>
                            <calendar-range :value="(startDate && endDate) ? startDate + '/' + endDate : ''" @change.native="date = $el.value; setDate()" class="cally bg-base-100 border border-base-300 shadow-lg rounded-box " months="2">
                            <svg aria-label="Previous"
                                 class="fill-current size-4"
                                 slot="previous"
                                 xmlns="http://www.w3.org/2000/svg"
                                 viewBox="0 0 24 24">
                                <path fill="currentColor" d="M15.75 19.5 8.25 12l7.5-7.5"></path>
                            </svg>
                            <svg aria-label="Next"
                                 class="fill-current size-4"
                                 slot="next"
                                 xmlns="http://www.w3.org/2000/svg"
                                 viewBox="0 0 24 24">
                                <path fill="currentColor" d="m8.25 4.5 7.5 7.5-7.5 7.5"></path>
                            </svg>
                            <div class=" flex gap-4 justify-center flex-col lg:flex-row">
                                <calendar-month></calendar-month>
                                <calendar-month class="hidden lg:block" offset="1"></calendar-month>
                            </div>
                            </calendar-range>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <a v-if="sidebar.path == '/finanzas/basura/'"
           href="{% url 'lider_general:inventario_lista' %}"
           class="btn btn-ghost h-fit w-fit">
            <svg xmlns="http://www.w3.org/2000/svg"
                 class="size-4"
                 viewBox="0 0 256 256">
                <!-- Icon from Phosphor by Phosphor Icons - https://github.com/phosphor-icons/core/blob/main/LICENSE -->
                <path fill="currentColor" d="M128 24c-53.83 0-96 24.6-96 56v96c0 31.4 42.17 56 96 56s96-24.6 96-56V80c0-31.4-42.17-56-96-56m80 104c0 9.62-7.88 19.43-21.61 26.92C170.93 163.35 150.19 168 128 168s-42.93-4.65-58.39-13.08C55.88 147.43 48 137.62 48 128v-16.64c17.06 15 46.23 24.64 80 24.64s62.94-9.68 80-24.64ZM69.61 53.08C85.07 44.65 105.81 40 128 40s42.93 4.65 58.39 13.08C200.12 60.57 208 70.38 208 80s-7.88 19.43-21.61 26.92C170.93 115.35 150.19 120 128 120s-42.93-4.65-58.39-13.08C55.88 99.43 48 89.62 48 80s7.88-19.43 21.61-26.92m116.78 149.84C170.93 211.35 150.19 216 128 216s-42.93-4.65-58.39-13.08C55.88 195.43 48 185.62 48 176v-16.64c17.06 15 46.23 24.64 80 24.64s62.94-9.68 80-24.64V176c0 9.62-7.88 19.43-21.61 26.92" />
            </svg>
            Ver Inventario de Basura
        </a>
        <div class="flex flex-wrap items-center gap-1">
            <a href="{% url 'ver_finanzas_gestion' categoria_slug=categoria_slug %}"
               class="btn btn-ghost h-fit w-fit">
                <svg xmlns="http://www.w3.org/2000/svg"
                     class="size-4"
                     viewBox="0 0 256 256">
                    <!-- Icon from Phosphor by Phosphor Icons - https://github.com/phosphor-icons/core/blob/main/LICENSE -->
                    <path fill="currentColor" d="M224 128a96 96 0 0 1-94.71 96H128a95.38 95.38 0 0 1-65.9-26.2a8 8 0 0 1 11-11.63a80 80 0 1 0-1.67-114.78a3 3 0 0 1-.26.25l-10.54 9.65l17 17A8 8 0 0 1 72 112H24a8 8 0 0 1-8-8V56a8 8 0 0 1 13.66-5.7L49.31 70l10.94-10A96 96 0 0 1 224 128" />
                </svg>
                Limpiar Filtros
            </a>
            <button @click="downloadpdf()" class="btn btn-dash btn-secondary h-fit w-fit">
                <svg xmlns="http://www.w3.org/2000/svg"
                     class="size-4"
                     viewBox="0 0 256 256">
                    <!-- Icon from Phosphor by Phosphor Icons - https://github.com/phosphor-icons/core/blob/main/LICENSE -->
                    <path fill="currentColor" d="M224 144v64a8 8 0 0 1-8 8H40a8 8 0 0 1-8-8v-64a8 8 0 0 1 16 0v56h160v-56a8 8 0 0 1 16 0m-101.66 5.66a8 8 0 0 0 11.32 0l40-40a8 8 0 0 0-11.32-11.32L136 124.69V32a8 8 0 0 0-16 0v92.69L93.66 98.34a8 8 0 0 0-11.32 11.32Z" />
                </svg>
                Descargar PDF
            </button>
        </div>
    </div>
{% endblock toolbaritems %}
{% block content %}
    <div v-scope
         @vue:mounted="navbar.change('{{ titulo }}'); navbar.toolbarOpen()"
         class="min-h-[calc(100svh-8rem)] max-w-screen overflow-hidden p-8 flex flex-col justify-stretch items-start ">
        {% if movimientos %}
            <div class="overflow-x-auto w-full max-h-[calc(100svh-12rem)] rounded-box border border-base-content/5 bg-base-100">
                <table class="table table-sm lg:table-md table-pin-rows table-zebra text-center">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Tasa BCV</th>
                            <th>Descripción</th>
                            <th>Ingresos (Bs)</th>
                            <th>Egresos (Bs)</th>
                            <th>Torre</th>
                            <th>Saldo Acumulado (Bs)</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for mov in movimientos %}
                            <tr>
                                <td>{{ mov.fecha|date:"Y-m-d" }}</td>
                                <td>{{ mov.tasa_bcv|floatformat:2 }}</td>
                                <td>{{ mov.descripcion }}</td>
                                <td class="text-success">{{ mov.ingreso|default_if_none:"" }}</td>
                                <td class="text-warning">{{ mov.egreso|default_if_none:"" }}</td>
                                <td>
                                    {% if mov.tipo == 'EGR' and mov.categoria == 'BAS' %}
                                        <span class="badge bg-secondary">General</span>
                                    {% else %}
                                        {{ mov.torre }}
                                    {% endif %}
                                </td>
                                <td>{{ mov.saldo }}</td>
                                <td class="text-end flex flex-wrap justify-center">
                                    {% with user_groups=user.groups.all|stringformat:"s" %}
                                        {% if user.is_staff or "Lider General" in user_groups or mov.tower == user.tower %}
                                            {% if mov.id %}
                                                <a href="{% url 'lider_torre:editar_movimiento' mov.id %}"
                                                   class="btn btn-sm btn-neutral"
                                                   title="Editar">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="size-4" viewBox="0 0 24 24">
                                                        <!-- Icon from Material Symbols by Google - https://github.com/google/material-design-icons/blob/master/LICENSE -->
                                                        <path fill="currentColor" d="M5 19h1.425L16.2 9.225L14.775 7.8L5 17.575zm-2 2v-4.25L16.2 3.575q.3-.275.663-.425t.762-.15t.775.15t.65.45L20.425 5q.3.275.438.65T21 6.4q0 .4-.137.763t-.438.662L7.25 21zM19 6.4L17.6 5zm-3.525 2.125l-.7-.725L16.2 9.225z" />
                                                    </svg>
                                                </a>
                                            {% endif %}
                                        {% else %}
                                            <a class="btn btn-sm opacity-25" title="No action">
                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                     class="size-4 "
                                                     viewBox="0 0 24 24">
                                                    <!-- Icon from Tabler Icons by Paweł Kuna - https://github.com/tabler/tabler-icons/blob/master/LICENSE -->
                                                    <path fill="currentColor" d="M15 21a1 1 0 0 1 0-2h1v-2H8v2h1a1 1 0 0 1 0 2H5a1 1 0 0 1 0-2h1v-2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h1V5a1 1 0 1 1 2 0v1h8V5a1 1 0 0 1 2 0v1h1a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2h-1v2h1a1 1 0 0 1 0 2zM12.914 8l-7 7h4.17L17 8zM19 10.914L14.914 15H19zM8.084 8H5v3.084z" />
                                                </svg>
                                            </a>
                                        {% endif %}
                                    {% endwith %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="flex justify-center items-center w-full ">
                <div role="alert" class="alert alert-warning alert-outline ">
                    <span class="text-lg">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             class="size-6 inline-block"
                             viewBox="0 0 16 16">
                            <!-- Icon from Rivet Icons by Indiana University - https://github.com/indiana-university/rivet-icons/blob/develop/LICENSE -->
                            <g fill="currentColor">
                            <path d="M8 2a6 6 0 1 0 0 12A6 6 0 0 0 8 2M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8" />
                            <path d="M11 6a1 1 0 1 1-2 0a1 1 0 0 1 2 0M7 6a1 1 0 1 1-2 0a1 1 0 0 1 2 0m2.742 5.152a1 1 0 0 0 1.526-1.292l-.001-.002l-.001-.001l-.003-.004l-.007-.008l-.018-.02a3 3 0 0 0-.225-.224a4 4 0 0 0-.623-.458A4.6 4.6 0 0 0 8 8.5a4.6 4.6 0 0 0-2.39.643a4 4 0 0 0-.795.624l-.053.057l-.018.021l-.007.008l-.003.004v.001l-.002.001a1 1 0 0 0 1.526 1.293l.005-.005q.014-.016.062-.06a2 2 0 0 1 .314-.23A2.6 2.6 0 0 1 8 10.5c.624 0 1.073.185 1.36.357a2 2 0 0 1 .382.295" />
                            </g>
                        </svg>
                        No se encontraron movimientos financieros
                    </span>
                </div>
            </div>
        {% endif %}
        {# --- BLOQUE DE BOTONES DE ACCIÓN --- #}
        {% if request.user.is_authenticated %}
            <div class="fab">
                <div tabindex="0" role="button" class="btn btn-lg btn-accent">
                    <span>Acciones
                        <svg xmlns="http://www.w3.org/2000/svg"
                             class="inline size-6"
                             viewBox="0 0 24 24">
                            <g fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="m13 11l5-5" />
                            <path stroke-linejoin="round" d="m19 7l-2-2l2.5-1.5l1 1zM4.025 8.975a3.5 3.5 0 0 1-.79-3.74l1.422 1.422h2v-2L5.235 3.235a3.5 3.5 0 0 1 4.529 4.53l6.47 6.471a3.5 3.5 0 0 1 4.53 4.529l-1.421-1.422h-2v2l1.422 1.422a3.5 3.5 0 0 1-4.53-4.528L7.763 9.765a3.5 3.5 0 0 1-3.738-.79Z" />
                            <path stroke-linejoin="round" d="m12.203 14.5l-5.604 5.604a1.35 1.35 0 0 1-1.911 0l-.792-.792a1.35 1.35 0 0 1 0-1.911L9.5 11.797" />
                            </g>
                        </svg>
                    </span>
                </div>
                {% if categoria_slug == 'condominio' %}
                    <a href="{% if request.user.rol == 'LDT' %}{% url 'lider_torre:ingresar_condominio' %}{% elif request.user.rol == 'LDG' %}{% url 'lider_general:ingresar_condominio_general' %}{% endif %}"
                       class="btn btn-lg btn-success">Registrar Ingreso</a>
                    <a href="{% if request.user.rol == 'LDT' %}{% url 'lider_torre:egresar_condominio' %}{% elif request.user.rol == 'LDG' %}{% url 'lider_general:egresar_condominio_general' %}{% endif %}"
                       class="btn btn-lg btn-warning">Registrar Egreso</a>
                    {# Condominio: LDT (su torre) y LDG (cualquier torre) #}
                    {% if request.user.rol == 'LDT' or request.user.rol == 'LDG' or request.user.is_staff %}
                        <button onclick="modal_publicar_reporte.showModal()"
                                class="btn btn-lg btn-primary">Publicar Reporte Condominio</button>
                    {% endif %}
                {% elif categoria_slug == 'basura' %}
                    <a href="{% if request.user.rol == 'LDT' %}{% url 'lider_torre:ingresar_basura' %}{% elif request.user.rol == 'LDG' %}{% url 'lider_general:ingresar_basura_general' %} {% endif %}"
                       class="btn btn-lg btn-success">Registrar Ingreso</a>
                    {% if request.user.rol == 'LDG' or request.user.es_admin_basura %}
                        <a href="{% url 'lider_general:egresar_basura_general' %}"
                           class="btn btn-lg btn-warning">Registrar Egreso</a>
                        <a href="{% url 'lider_general:estado_solvencia_basura' %}"
                           class="btn btn-lg btn-info">Ver Tablero de Solvencia</a>
                        {# Basura: Solo LDG o Admin Basura (Reporte General) #}
                        <button onclick="modal_publicar_reporte.showModal()"
                                class="btn btn-lg btn-primary">Publicar Reporte Basura</button>
                    {% endif %}
                {% endif %}
            </div>
        {% endif %}
        {# --- FIN BLOQUE DE BOTONES DE ACCIÓN --- #}
    </div>
    <dialog id="modal_publicar_reporte" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Publicar Reporte Mensual</h3>
            <p class="py-4 text-sm opacity-70">Esto cerrará el balance del mes seleccionado y lo hará visible para los vecinos.</p>
            <form method="POST" action="{% url 'publicar_reporte' %}">
                {% csrf_token %}
                <input type="hidden" name="categoria_slug" value="{{ categoria_slug }}">
                <div class="grid grid-cols-1 gap-4">
                    <div class="form-control">
                        {% if request.user.rol == 'LDG' or request.user.is_staff %}
                            <label class="label">
                                <span class="label-text">Seleccionar Entidad</span>
                            </label>
                            <select name="tower_id" class="select select-bordered" required>
                                <option value="0">General (Toda la Residencia)</option>
                                {% for t in torres %}<option value="{{ t.id }}">Torre {{ t.nombre }}</option>{% endfor %}
                            </select>
                        {% else %}
                            <div class="alert alert-info py-2">
                                <span class="text-xs">Publicando para: <strong>Torre {{ request.user.tower.nombre }}</strong></span>
                            </div>
                        {% endif %}
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Mes</span>
                            </label>
                            <select name="mes" class="select select-bordered" required>
                                {% for num, nombre in meses_listado %}
                                    <option value="{{ num }}" {% if num == mes_actual %}selected{% endif %}>{{ nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Año</span>
                            </label>
                            <select name="anio" class="select select-bordered" required>
                                {% for anio in anios_disponibles %}
                                    <option value="{{ anio }}" {% if anio == anio_actual %}selected{% endif %}>{{ anio }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-action">
                    <button type="submit" class="btn btn-success">Confirmar y Publicar</button>
                    <button type="button" onclick="modal_publicar_reporte.close()" class="btn">Cancelar</button>
                </div>
            </form>
        </div>
    </dialog>
{% endblock content %}
